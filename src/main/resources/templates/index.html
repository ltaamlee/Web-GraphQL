<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light p-4">
<div class="container">

    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand text-primary" href="#">LTaam</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/products}">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/categories}">Categories</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/users}">Users</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <h1 class="text-primary mb-4">All Products</h1>

    <div class="mb-3">
        <label for="categorySelect" class="form-label">Filter by Category</label>
        <select id="categorySelect" class="form-select">
            <option value="">-- All Categories --</option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Price</th>
                <th>Quantity</th>
            </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    function loadCategories(){
        const query = `{ allCategories { id name } }`;
        axios.post('/graphql', { query }).then(res => {
            const categories = res.data.data.allCategories;
            const select = document.getElementById('categorySelect');
            categories.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.text = c.name;
                select.appendChild(option);
            });
        });
    }

    function loadProducts(categoryId){
        let query = '';
        if(categoryId){
            query = `{ productsByCategory(categoryId:${categoryId}) { id title price quantity } }`;
        } else {
            query = `{ allProductsSorted { id title price quantity } }`;
        }
        axios.post('/graphql', { query }).then(res => {
            const products = categoryId ? res.data.data.productsByCategory : res.data.data.allProductsSorted;
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            products.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.title}</td>
                    <td>${p.price}</td>
                    <td>${p.quantity}</td>
                `;
                tbody.appendChild(tr);
            });
        });
    }

    document.getElementById('categorySelect').addEventListener('change', function(){
        loadProducts(this.value);
    });

    loadCategories();
    loadProducts();
</script>
</body>
</html>
